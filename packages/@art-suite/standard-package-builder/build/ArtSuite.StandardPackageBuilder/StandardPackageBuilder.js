"use strict"
let Caf = require('caffeine-script-runtime');
Caf.defMod(module, () => {return Caf.importInvoke(["merge", "compactFlatten"], [global, require('art-standard-lib')], (merge, compactFlatten) => {let nodemonExtensions, nodemonCommand; nodemonExtensions = "js,ts,jsx,tsx,caf,coffee,json"; nodemonCommand = `nodemon -e ${Caf.toString(nodemonExtensions)} -x`; return {configure: function(options = {}) {return (_package) => {let sourceDir, targetDir, mocha, mochaAndJest, coffeeScript, scripts, currentPackage, targetTempDir, buildScript, temp, temp1, temp2; if (Caf.exists(options)) {sourceDir = (undefined !== (temp = options.sourceDir)) ? temp : "source"; targetDir = (undefined !== (temp1 = options.targetDir)) ? temp1 : "build"; mocha = options.mocha; mochaAndJest = options.mochaAndJest; coffeeScript = options.coffeeScript; scripts = options.scripts; currentPackage = (undefined !== (temp2 = options.package)) ? temp2 : _package;}; targetTempDir = targetDir + "-temp"; buildScript = (sourceDir, targetDir) => {let rsyncCommon, copyNonCompiledSourceFiles; rsyncCommon = compactFlatten(["-av", "--exclude='*.caf'", coffeeScript ? "--exclude='*.coffee'" : undefined]).join(" "); copyNonCompiledSourceFiles = `rsync ${Caf.toString(rsyncCommon)} ./${Caf.toString(sourceDir)}/ ./${Caf.toString(targetDir)}/`; return coffeeScript ? `${Caf.toString(copyNonCompiledSourceFiles)}\ncoffee -m --output ${Caf.toString(targetDir)} --compile ${Caf.toString(sourceDir)} &\nCOFFEE_PID=\$!\ncaf -m -c ${Caf.toString(sourceDir)} -o ${Caf.toString(targetDir)} ${Caf.toString(coffeeScript && "--require coffee-script/register")}&\nCAF_PID=\$!\nwait \$COFFEE_PID || exit 1\nwait \$CAF_PID || exit 1\nnpm run nn` : `${Caf.toString(copyNonCompiledSourceFiles)}\ncaf -m -c ${Caf.toString(sourceDir)} -o ${Caf.toString(targetDir)}\nnpm run nn`;}; return merge(currentPackage, {scripts: merge({nn: `nn ${Caf.toString(targetDir)}/* ${Caf.toString(mocha ? "test/tests" : undefined)}`, test: mochaAndJest ? "jest\nif [[ $? -ne 0 ]]; then\n  exit 1\nfi\nmocha -u tdd" : mocha ? "mocha -u tdd" : "jest", "test-watch": (mochaAndJest || mocha) ? `${Caf.toString(nodemonCommand)} npm run test` : "jest --watch", build: buildScript(sourceDir, targetDir), "build-clean": `# BUILD CLEAN START\n#   - building into: ${Caf.toString(targetTempDir)}\n#\nrm -rf ./__build-old__\n` + buildScript(sourceDir, targetTempDir) + `\n\nnn ${Caf.toString(targetTempDir)}/*\n\n# BUILD CLEAN FINIALIZING\n#  - replace old build in:   ${Caf.toString(targetDir)}\n#  - with new build from:    ${Caf.toString(targetTempDir)}\n#\nmv ${Caf.toString(targetDir)} __build-old__\nmv ${Caf.toString(targetTempDir)} ${Caf.toString(targetDir)}\nrm -rf ./__build-old__`, "build-watch": `nodemon -e ${Caf.toString(nodemonExtensions)} -w "${Caf.toString(sourceDir)}/**" -x npm run build`, clean: `rm -rf ${Caf.toString(targetDir)}/*`}, scripts), jest: {testEnvironment: "node", verbose: true, collectCoverageFrom: [`${Caf.toString(targetDir)}/**/*.js`, `!${Caf.toString(targetDir)}/test/**/*.js`], coveragePathIgnorePatterns: ["/index.js$", "/namespace.js$"], testPathIgnorePatterns: ["/node_modules/", "<rootDir>/test", "<rootDir>/source", "<rootDir>/build/test", "<rootDir>/build/tests"]}});};}};});});
//# sourceMappingURL=StandardPackageBuilder.js.map
