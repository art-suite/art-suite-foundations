import &StandardImport

resetGlobals = ->
  global.artConfig = null
  global.artConfigName = null

testArtConfigGlobalConfig = (name, f) ->
  test name, ->
    value = f()
    assert.eq Main.artConfig, merge
      Tests: Art: Config: name: "TestName", verbose: false
      value

suite:
  globalArtConfig: ->
    setup ->
      configure()

    test "Art.config"     -> assert.equal Main.artConfig, Neptune.Art.config
    test "Art.configName" -> assert.equal Main.artConfigName, Neptune.Art.configName

    test "Art.Config.config"     -> assert.equal Main.artConfig,     Neptune.Art.Config.config
    test "Art.Config.configName" -> assert.equal Main.artConfigName, Neptune.Art.Config.configName

  artConfigSources: ->
    setup resetGlobals
    teardown resetGlobals

    testArtConfigGlobalConfig "args", ->
      configure artConfig: foo: "argsBar"
      foo: "argsBar"

    testArtConfigGlobalConfig "global.artConfig", ->
      global.artConfig = foo: "globalBar"
      configure()
      foo: "globalBar"

    testArtConfigGlobalConfig "env", ->
      configure artConfig: {}, __testEnv: artConfig: foo: "envBar"
      foo: "envBar"

  pathedConfigProps: ->
    setup resetGlobals
    teardown resetGlobals

    testArtConfigGlobalConfig "foo.bar: 'globalBar'", ->
      global.artConfig = "foo.bar": "globalBar"
      configure()
      foo: bar: "globalBar"

  artConfigNameSources: ->
    setup resetGlobals
    teardown resetGlobals

    testArtConfigGlobalConfig "baseline", ->
      configure()
      assert.eq Main.artConfigName, "Development"
      {}

    testArtConfigGlobalConfig "args", ->
      configure artConfigName: 'TestConfig'
      assert.eq Main.artConfigName, 'TestConfig'
      propA: "propAFromTestConfig"
      MyGrouping: propB: "foo",  propC: "bar"

    testArtConfigGlobalConfig "global", ->
      global.artConfigName = 'TestConfig'
      configure()
      assert.eq Main.artConfigName, 'TestConfig'
      propA: "propAFromTestConfig"
      MyGrouping: propB: "foo",  propC: "bar"


    testArtConfigGlobalConfig "env", ->
      configure artConfig: {}, __testEnv: artConfigName: 'TestConfig'
      assert.eq Main.artConfigName, 'TestConfig'
      propA: "propAFromTestConfig"
      MyGrouping: propB: "foo",  propC: "bar"

  configs: ->
    test "TestConfig got registered", ->
      assert.eq
        ConfigRegistry.configs
        TestConfig:
          propA: "propAFromTestConfig"
          MyGrouping: propB: "foo",  propC: "bar"
